name: Monorepo CI

on: [push, pull_request]

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      areas: ${{ steps.changes.outputs.areas_json }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Detect changes
        id: changes
        uses: f1rmtea/changed-files@main

  test:
    needs: detect-changes
    runs-on: ubuntu-latest
    strategy:
      matrix:
        area: [backend, frontend, api, workers]
    steps:
      - uses: actions/checkout@v4
      
      - name: Check if area changed
        id: check
        run: |
          AREAS='${{ needs.detect-changes.outputs.areas }}'
          CHANGED=$(echo $AREAS | jq -r '."${{ matrix.area }}".changed')
          echo "changed=$CHANGED" >> $GITHUB_OUTPUT
      
      - name: Run tests for ${{ matrix.area }}
        if: steps.check.outputs.changed == 'true'
        run: npm run test:${{ matrix.area }}